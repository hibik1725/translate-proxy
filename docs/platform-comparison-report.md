# translate-proxy デプロイ先比較レポート

## Cloudflare Workers vs Railway

**作成日**: 2024-12-23

---

## 1. プロジェクト特性の分析

translate-proxyの実装を確認した結果、以下の特性があります：

### アーキテクチャ

- **フレームワーク**: Hono（エッジ最適化）
- **翻訳エンジン**: OpenAI API（gpt-4o-mini）
- **キャッシュ**: Cloudflare KV（テキスト単位で永続キャッシュ）
- **処理内容**: HTML/JS のパース → 日本語テキスト抽出 → 翻訳 → 再構築

### リソース使用パターン

| 項目 | 特性 |
|------|------|
| CPU | バースト型（リクエスト時のみ） |
| メモリ | HTMLパース時に一時的に使用（数MB程度） |
| ネットワーク | オリジン(Vercel)への往復 + OpenAI API呼び出し |
| ストレージ | KVに翻訳結果を永続保存 |

---

## 2. プラットフォーム比較

### 2.1 料金比較

#### Cloudflare Workers

| 項目 | 無料枠 | 有料（$5/月〜） |
|------|--------|----------------|
| リクエスト数 | 10万/日 | 1000万/月 |
| KV読み取り | 10万/日 | 1000万/月 |
| KV書き込み | 1,000/日 | 100万/月 |
| CPU時間 | 10ms/リクエスト | 50ms/リクエスト |
| 追加料金 | - | $0.30/100万リクエスト |

**translate-proxyの場合の試算**:

- 月間10万PV → 無料枠内で運用可能
- 月間100万PV → 約$5〜15/月

#### Railway

| 項目 | 無料枠 | 有料 |
|------|--------|------|
| 実行時間 | $5相当/月 | 従量課金 |
| メモリ | 512MB〜 | $0.000231/GB/分 |
| CPU | 共有 | $0.000463/vCPU/分 |
| 帯域 | 100GB | $0.10/GB |

**translate-proxyの場合の試算**:

- 常時起動が必要 → 月間約$5〜20
- 月間100万PV → 約$15〜40/月（スケールアウト時）

### 2.2 パフォーマンス比較

| 項目 | Cloudflare Workers | Railway |
|------|-------------------|---------|
| **コールドスタート** | ほぼなし（<5ms） | あり（100ms〜数秒） |
| **実行ロケーション** | 310+エッジロケーション | リージョン固定（1箇所） |
| **日本からのレイテンシ** | 低い（東京エッジあり） | リージョン依存 |
| **グローバル対応** | 自動（エッジ分散） | 追加設定必要 |

**translate-proxyへの影響**:

- SEO目的（Googlebot対応）→ グローバル対応が重要
- 初回アクセス時のレスポンス → コールドスタートが影響

### 2.3 KVキャッシュの扱い

#### Cloudflare Workers

- Cloudflare KV が組み込み
- 現在の実装がそのまま使用可能
- エッジに分散されたKV読み取り
- 追加設定不要

#### Railway

- 外部DBが必要（Redis, PostgreSQL等）
- KvCacheService の書き換えが必要
- DB料金が追加で発生
- ネットワークレイテンシ増加

**移行コスト**: Railwayの場合、キャッシュ層の再実装が必要

### 2.4 メンテナンス性

| 項目 | Cloudflare Workers | Railway |
|------|-------------------|---------|
| **デプロイ** | `wrangler deploy` | Git push / CLI |
| **環境変数** | Cloudflare Dashboard / wrangler | Railway Dashboard |
| **ログ** | Cloudflare Dashboard | Railway Dashboard |
| **モニタリング** | 組み込み | 基本的なメトリクス |
| **Honoとの相性** | 最適化済み | 追加設定必要 |

---

## 3. translate-proxy固有の考慮事項

### 3.1 翻訳処理の特性

```
リクエスト → オリジンHTML取得 → パース → KVキャッシュ確認
    → [キャッシュミス時] OpenAI API → KV保存 → HTML再構築 → レスポンス
```

**ボトルネック分析**:

1. **OpenAI API呼び出し**: 最も遅い（キャッシュで解決）
2. **オリジンHTML取得**: Vercelへの往復（両プラットフォーム同等）
3. **HTMLパース/再構築**: CPU負荷（Workersの10ms制限に注意）

### 3.2 Cloudflare Workers の制限事項

| 制限 | 無料 | 有料 |
|------|------|------|
| CPU時間/リクエスト | 10ms | 50ms |
| メモリ | 128MB | 128MB |
| スクリプトサイズ | 1MB | 10MB |
| サブリクエスト | 50 | 1000 |

**translate-proxyへの影響**:

- 大きなHTML（10MB超）→ メモリ不足の可能性
- 多数のテキストノード → OpenAI APIコール数制限

### 3.3 Railway の利点

- CPU/メモリ制限が緩い
- 長時間実行が可能
- コンテナベースで柔軟

---

## 4. 総合評価

### スコアカード（5点満点）

| 項目 | Cloudflare Workers | Railway |
|------|:------------------:|:-------:|
| コスト（低トラフィック） | 5 | 3 |
| コスト（高トラフィック） | 4 | 3 |
| パフォーマンス | 5 | 3 |
| グローバル対応 | 5 | 2 |
| 実装の移行コスト | 5 | 2 |
| メンテナンス性 | 4 | 4 |
| 柔軟性（制限の緩さ） | 3 | 5 |

### 推奨

| シナリオ | 推奨プラットフォーム |
|----------|---------------------|
| 現状維持・低〜中トラフィック | **Cloudflare Workers** |
| グローバルSEO重視 | **Cloudflare Workers** |
| 複雑な処理・長時間実行が必要 | Railway |
| 既存Railwayインフラがある | Railway |

---

## 5. 結論

**translate-proxyにはCloudflare Workersが適している理由**:

1. **KVキャッシュとの統合**: 現在の実装がそのまま使える
2. **エッジ実行**: SEO対策（Googlebot対応）に有利
3. **コスト効率**: 低〜中トラフィックで圧倒的に安価
4. **Honoとの相性**: 最適化済みで追加設定不要
5. **コールドスタートなし**: 初回アクセスでも高速レスポンス

**Railwayを選ぶべきケース**:

- HTMLサイズが非常に大きく、Workers の制限に引っかかる場合
- 他のRailwayサービスとの統合が必要な場合

---

## 6. 別アカウントへの移行手順（Cloudflare Workers）

現在のCloudflare Workersでの運用を継続し、別アカウントに移行する場合：

### 手順

```bash
# 1. 新しいアカウントでログイン
wrangler login

# 2. KV Namespaceを作成
wrangler kv:namespace create TRANSLATION_CACHE

# 3. wrangler.toml のKV IDを更新
# id = "新しいID"

# 4. シークレットを設定
wrangler secret put OPENAI_API_KEY

# 5. デプロイ
pnpm deploy

# 6. picker-app の vercel.json を新しいURLに更新
```

### 注意事項

- 既存のKVキャッシュデータは移行されない（再翻訳が必要）
- 新しいWorkers URLが発行される
- picker-app側のrewrite設定の更新が必要
